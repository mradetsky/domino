{"version":3,"file":"ui-router-dsr.js","sources":["../src/dsr.ts"],"sourcesContent":["import {\n    StateObject, StateDeclaration, Param, UIRouter, RawParams, StateOrName, TargetState, Transition\n} from \"@uirouter/core\";\n\ndeclare module \"@uirouter/core\" {\n  interface StateDeclaration {\n    dsr?: any;\n    deepStateRedirect?: any;\n  }\n}\n\nfunction DSRPlugin($uiRouter: UIRouter): any {\n  let $transitions = $uiRouter.transitionService;\n  let $state = $uiRouter.stateService;\n\n  $transitions.onRetain({ retained: getDsr }, recordDeepState);\n  $transitions.onEnter({ entering: getDsr }, recordDeepState);\n  $transitions.onBefore({ to: getDsr }, deepStateRedirect);\n\n  function getDsr(state: StateDeclaration) {\n    return state.deepStateRedirect || state.dsr;\n  }\n\n  function getConfig(state: StateDeclaration) {\n    let dsrProp: any = getDsr(state);\n    let propType: string = typeof dsrProp;\n    if (propType === 'undefined') return;\n\n    let params;\n    let defaultTarget = propType === 'string' ? dsrProp : undefined;\n    let fn: Function = propType === 'function' ? dsrProp : undefined;\n\n    if (propType === 'object') {\n      fn = dsrProp.fn;\n      let defaultType = typeof dsrProp.default;\n      if (defaultType === 'object') {\n        defaultTarget = $state.target(dsrProp.default.state, dsrProp.default.params, dsrProp.default.options);\n      } else if (defaultType === 'string') {\n        defaultTarget = $state.target(dsrProp.default);\n      }\n      if (dsrProp.params === true) {\n        params = function () {\n          return true;\n        }\n      } else if (Array.isArray(dsrProp.params)) {\n        params = function (param: Param) {\n          return dsrProp.params.indexOf(param.id) !== -1;\n        }\n      }\n    }\n\n    fn = fn || ((transition, target) => target);\n\n    return { params: params, default: defaultTarget, fn: fn };\n  }\n\n  function paramsEqual(state: StateObject, transParams: RawParams, schemaMatchFn?: (param?: Param) => boolean, negate = false) {\n    schemaMatchFn = schemaMatchFn || (() => true);\n    let schema = state.parameters({ inherit: true }).filter(schemaMatchFn);\n    return function (redirect) {\n      let equals = Param.equals(schema, redirect.triggerParams, transParams);\n      return negate ? !equals : equals;\n    }\n  }\n\n  function recordDeepState(transition, state) {\n    let paramsConfig = getConfig(state).params;\n\n    transition.promise.then(function () {\n      let transTo = transition.to();\n      let transParams = transition.params();\n      let recordedDsrTarget = $state.target(transTo, transParams);\n\n      if (paramsConfig) {\n        state.$dsr = (state.$dsr || []).filter(paramsEqual(transTo.$$state(), transParams, undefined, true));\n        state.$dsr.push({ triggerParams: transParams, target: recordedDsrTarget });\n      } else {\n        state.$dsr = recordedDsrTarget;\n      }\n    });\n  }\n\n  function deepStateRedirect(transition: Transition) {\n    let opts = transition.options();\n    if (opts['ignoreDsr'] || (opts.custom && opts.custom.ignoreDsr)) return;\n\n    let config = getConfig(transition.to());\n    let redirect = getDeepStateRedirect(transition.to(), transition.params());\n    redirect = config.fn(transition, redirect);\n    if (redirect && redirect.state() === transition.to()) return;\n\n    return redirect;\n  }\n\n  function getDeepStateRedirect(stateOrName: StateOrName, params: RawParams) {\n    let state = $state.get(stateOrName);\n    let dsrTarget, config = getConfig(state);\n    let $$state = state.$$state();\n\n    if (config.params) {\n      var predicate = paramsEqual($$state, params, config.params, false);\n      let match = $$state['$dsr'] && $$state['$dsr'].filter(predicate)[0];\n      dsrTarget = match && match.target;\n    } else {\n      dsrTarget = $$state['$dsr'];\n    }\n\n    dsrTarget = dsrTarget || config.default;\n\n    if (dsrTarget) {\n      // merge original params with deep state redirect params\n      let targetParams = Object.assign({}, params, dsrTarget.params());\n      dsrTarget = $state.target(dsrTarget.state(), targetParams, dsrTarget.options());\n    }\n\n    return dsrTarget;\n  }\n\n  return {\n    name: 'deep-state-redirect',\n\n    reset: function(state: StateOrName, params?: RawParams) {\n      if (!state) {\n        $state.get().forEach(state => delete state.$$state()['$dsr']);\n      } else if (!params) {\n        delete $state.get(state).$$state()['$dsr']\n      } else {\n        var $$state = $state.get(state).$$state();\n        $$state['$dsr'] = $$state['$dsr'].filter(paramsEqual($$state, params, null, true));\n      }\n    },\n\n    getRedirect: function (state: StateOrName, params?: RawParams) {\n      return getDeepStateRedirect(state, params);\n    },\n  };\n}\n\nexport { DSRPlugin };\n"],"names":["Param"],"mappings":"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"}